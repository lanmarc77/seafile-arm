name: Build
on: workflow_dispatch

jobs:
  BuildAll:
    runs-on: ubuntu-latest
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      - name: Build
        run: |
           cp .env.example .env
           sed -i 's/PLATFORMS=".*"/PLATFORMS="linux\/amd64"/g' .env
           sed -i 's/docker buildx create/docker buildx create --config .\/buildkit.toml/g' ./build_image.sh
           sed -i 's/SEAFILE_VERSION=/SEAFILE_VERSION=$VERSION/g' ./build.sh
           sed -i '66 i TAGS="$TAGS -t $([ "$REGISTRY" ] && echo $REGISTRY/)$REPOSITORY/$IMAGE:latest"' ./build_image.sh
           #sed -i '67 i echo $TAGS' ./build_image.sh
           #cat ./build_image.sh
           sed -i 's/docker run -it --rm/docker run --rm/g' ./build_with_docker.sh
           chmod 755 ./build.sh
           chmod 755 ./build_with_docker.sh
           chmod 755 ./build_image.sh
           sudo apt-get install ca-certificates curl gnupg -y
           sudo install -m 0755 -d /etc/apt/keyrings
           curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
           sudo chmod a+r /etc/apt/keyrings/docker.gpg
           echo "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
           sudo apt-get update
           sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
           ./build_image.sh -t jammy -p
           docker ps -a
           docker images -a
           docker pull localhost:5000/seafile/builder:jammy
           docker images -a
           docker pull localhost:5000/seafile/builder:latest
           docker images -a
           ./build_with_docker.sh -T -A
      - name: Archive artifacts
        uses: actions/upload-artifact@v3
        with:
          name: packages
          path: |
            build/**/built-seafile-server-pkgs
